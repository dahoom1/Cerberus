// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  ANALYST
  PRO
  INSTITUTIONAL
}

enum ExchangeName {
  BINANCE
  COINBASE
  KRAKEN
  BYBIT
  OKX
  BITFINEX
  KUCOIN
  GATEIO
  HUOBI
  BITGET
}

model User {
  id                String           @id @default(uuid())
  email             String           @unique
  password          String
  firstName         String?
  lastName          String?
  isEmailVerified   Boolean          @default(false)
  emailVerifyToken  String?
  emailVerifyExpiry DateTime?
  resetPasswordToken String?
  resetPasswordExpiry DateTime?
  subscriptionTier  SubscriptionTier @default(ANALYST)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  apiKeys           ExchangeApiKey[]
  tradingSignals    TradingSignal[]
  alerts            Alert[]
  
  @@index([email])
}

model ExchangeApiKey {
  id          String       @id @default(uuid())
  userId      String
  exchange    ExchangeName
  apiKey      String       // Encrypted
  apiSecret   String       // Encrypted
  passphrase  String?      // Encrypted (for some exchanges)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, exchange])
  @@index([userId])
}

model TradingSignal {
  id              String      @id @default(uuid())
  userId          String?
  symbol          String      // e.g., "BTC/USDT"
  exchange        ExchangeName
  signalType      String      // "BUY", "SELL", "LONG", "SHORT"
  confidence      Float       // 0-100
  price           Float
  timestamp       DateTime    @default(now())
  indicators      Json        // Array of indicator values
  reason          String?
  executed        Boolean     @default(false)
  executionPrice  Float?
  executionTime   DateTime?

  // Sentiment & news fields
  sentimentScore      Float?      // -1 to +1 from VADER
  inverseSentiment    Float?      // Contrarian score
  newsScore           Float?      // 0-100 news sentiment
  sentimentWeight     Float?      // % of confidence from sentiment
  newsWeight          Float?      // % of confidence from news

  user            User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  performance     SignalPerformance?

  @@index([symbol, exchange])
  @@index([timestamp])
  @@index([userId])
}

model Alert {
  id          String      @id @default(uuid())
  userId      String
  type        String      // "LIQUIDATION", "PRICE", "INDICATOR", "SIGNAL"
  symbol      String
  exchange    ExchangeName?
  condition   String      // JSON string with alert conditions
  isActive    Boolean     @default(true)
  triggeredAt DateTime?
  createdAt   DateTime    @default(now())
  
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isActive])
}

model MarketData {
  id          String      @id @default(uuid())
  symbol      String
  exchange    ExchangeName
  timeframe   String      // "1m", "5m", "15m", "1h", "4h", "1d"
  open        Float
  high        Float
  low         Float
  close       Float
  volume      Float
  timestamp   DateTime
  indicators  Json?       // Calculated indicators
  
  @@unique([symbol, exchange, timeframe, timestamp])
  @@index([symbol, exchange, timeframe])
  @@index([timestamp])
}

model LiquidationZone {
  id              String      @id @default(uuid())
  symbol          String
  exchange        ExchangeName
  price           Float
  side            String      // "LONG", "SHORT"
  estimatedLiquidity Float
  confidence      Float       // 0-100
  reasoning       Json?       // Array of confidence factors
  suggestion      String?     // "BUY", "SELL", "NEUTRAL"
  stopLoss1       Float?
  stopLoss2       Float?
  takeProfit1     Float?
  takeProfit2     Float?
  heatmapData     Json?       // Array of {price, intensity, liquidity}
  detectedAt      DateTime    @default(now())
  triggeredAt     DateTime?

  @@index([symbol, exchange])
  @@index([detectedAt])
}

model SentimentData {
  id               String   @id @default(uuid())
  symbol           String   // "BTC", "ETH", "SOL", etc.
  source           String   // "TWITTER", "NEWS", "REDDIT"
  sentiment        Float    // -1 to +1 (VADER compound score)
  inverseSentiment Float    // Contrarian score
  volume           Int      // Number of posts/articles analyzed
  timestamp        DateTime @default(now())
  rawData          Json?    // Store sample posts/headlines

  @@index([symbol, timestamp])
  @@index([source, symbol])
}

model NewsArticle {
  id          String   @id @default(uuid())
  symbol      String   // Coin ticker
  title       String
  url         String   @unique
  source      String   // "COINDESK", "COINTELEGRAPH"
  publishedAt DateTime
  sentiment   Float    // -1 to +1
  score       Float    // News importance score 0-100
  summary     String?

  @@index([symbol, publishedAt])
  @@index([publishedAt])
}

model SignalPerformance {
  id               String         @id @default(uuid())
  signalId         String         @unique
  signal           TradingSignal  @relation(fields: [signalId], references: [id], onDelete: Cascade)

  // Real-time tracking
  currentPrice     Float?
  currentPnL       Float?      // Percentage profit/loss
  highestPrice     Float?      // Peak price during tracking
  lowestPrice      Float?      // Lowest price during tracking

  // 1-week accuracy (calculated after 7 days)
  weekEndPrice     Float?      // Price at end of 1 week
  directionCorrect Boolean?    // Did price move in predicted direction?
  priceChange      Float?      // Actual percentage change
  accuracyScore    Float?      // 0-100 final accuracy score
  performanceTier  String?     // "EXCELLENT", "GOOD", "AVERAGE", "POOR"

  // Timestamps
  trackingStarted  DateTime  @default(now())
  trackingEnded    DateTime?
  lastUpdated      DateTime  @updatedAt

  @@index([signalId])
  @@index([performanceTier])
}

model TopCoin {
  id            String   @id @default(uuid())
  symbol        String   @unique // "BTC", "ETH"
  name          String            // "Bitcoin", "Ethereum"
  marketCapRank Int
  marketCap     Float
  lastUpdated   DateTime @default(now())

  @@index([marketCapRank])
}

// Whale transaction records
model WhaleTransaction {
  id              String   @id @default(uuid())

  // Blockchain data
  txHash          String   @unique     // Transaction hash/ID
  blockchain      String                // "bitcoin", "ethereum", "binance-smart-chain", "solana"
  symbol          String                // "BTC", "ETH", "BNB", "SOL", "XRP"
  amount          Float                 // Amount in crypto (e.g., 100 BTC)
  amountUsd       Float                 // USD value at time of transaction

  // Addresses
  fromAddress     String
  fromOwner       String?               // "Binance", "Unknown Whale", null
  fromType        String?               // "exchange", "whale", "unknown"
  toAddress       String
  toOwner         String?
  toType          String?

  // Transaction metadata
  timestamp       DateTime
  blockNumber     Int?
  confirmations   Int?
  transactionType String                // "exchange_inflow", "exchange_outflow", "whale_movement", "unknown"

  // Alert flags
  significance    String   @default("medium")  // "low", "medium", "high", "critical"
  alertSent       Boolean  @default(false)

  // Source tracking
  source          String   @default("blockchain-api")
  rawData         Json?                 // Store original API response for debugging

  createdAt       DateTime @default(now())

  @@index([symbol, timestamp])
  @@index([transactionType, timestamp])
  @@index([blockchain, timestamp])
  @@index([fromOwner])
  @@index([toOwner])
  @@index([significance])
}

// Known exchange/whale wallet addresses
model WhaleWallet {
  id              String   @id @default(uuid())
  address         String   @unique
  blockchain      String                // "bitcoin", "ethereum", etc.
  ownerName       String                // "Binance Cold Wallet #1", "Coinbase Hot Wallet"
  ownerType       String                // "exchange", "whale", "custodian", "miner"
  exchange        String?               // "BINANCE", "COINBASE", "KRAKEN" (if exchange)

  // Metadata
  isVerified      Boolean  @default(false)
  lastSeen        DateTime?
  totalTxCount    Int      @default(0)
  notes           String?
  source          String?               // "manual", "etherscan", "community"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([blockchain, ownerType])
  @@index([exchange])
}

// Aggregated whale activity (for performance)
model WhaleActivitySummary {
  id              String   @id @default(uuid())

  symbol          String
  timeframe       String                // "1h", "24h", "7d"

  // Flow metrics
  exchangeInflow  Float    @default(0)  // Total USD flowing into exchanges
  exchangeOutflow Float    @default(0)  // Total USD flowing out of exchanges
  netFlow         Float    @default(0)  // Negative = accumulation

  // Transaction counts
  inflowTxCount   Int      @default(0)
  outflowTxCount  Int      @default(0)

  // Largest transaction
  largestTxAmount Float?
  largestTxHash   String?

  // Time window
  periodStart     DateTime
  periodEnd       DateTime
  updatedAt       DateTime @updatedAt

  @@unique([symbol, timeframe, periodStart])
  @@index([symbol, timeframe])
  @@index([periodStart])
}
